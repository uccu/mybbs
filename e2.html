<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title></title>
<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css">

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<!--[if IE 7]>
<link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css">
<![endif]-->

<!--[if lt IE 9]>
      <script src="//apps.bdimg.com/libs/html5shiv/r29/html5.min.js"></script>
      <script src="//apps.bdimg.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <style>
    .t,.t *{transition: all 0.3s;-moz-transition: all 0.3s;-webkit-transition: all 0.3s;-o-transition: all 0.3s}
    .t-1,.t-1 *{transition: all 1s;-moz-transition: all 1s;-webkit-transition: all 1s;-o-transition: all 1s}
    .t-2,.t-2 *{transition: all 2s;-moz-transition: all 2s;-webkit-transition: all 2s;-o-transition: all 2s}
    .t-n,{transition:none;-moz-transition:none;-webkit-transition:none;-o-transition:none}
    .top{
        background-color: #45818e;
        padding:20px;
        color: #fff;
    }
    
    .ad img{
        width: 100%;
    }
    .main{
        box-shadow: 0 0 1px #ccc; 
        padding:0
    }
    .message-box{
        background-color: #f9f8f8;
        height:500px;
        overflow: auto;
    }
    .message-bar{
        background-color: #f1f1f1;
        border-bottom: 1px solid #e6e6e6;
        border-top: 1px solid #e6e6e6;
        height: 30px;
    }
    .message-send{
        background-color: #fff;
        height: 140px;
        position: relative;
    }
    textarea{
        padding:10px;
        color:#666;
        width: 100%;
        height:100%;
        outline:0;
        border:none;
        resize: none;
    }
    .send{
        position: absolute;
        bottom: 4px;
        right: 4px;
        color:#fff;
        background-color: rgb(69, 129, 142);
        border-style: none solid none none;
        border-radius: 6px;
        outline:0;
        letter-spacing: 2px;
        width: 55px;

    }
    .send:hover{
        background-color: rgb(69, 192, 26);
    }

    .block-top{
        text-align: left;
        word-break: break-all;
        background-color: white;
        border: 1px solid #cccccc;
        border-radius: 5px;
        clear: both;
        color: #2e3531;
        line-height: 20px;
        margin: 10px 10px 4px;
        padding: 9px;
    }
    .block{
        position: relative;
        margin-left: 30px;
        clear: both;;
        margin-bottom: 0px;
        margin-left: 0px;
        margin-right: 0px;
        margin-top: 18px;
        text-align: left;
        display:block;
    }
    .block::after{
        display: block;
        clear: both;
        content: '';
    }
    .block .avatar{
        float: left;
        left: 0px;
        position: relative;
        top: 0px;
    }
    .block .content{
        margin-right: 15px;
        margin-left: 15px;
        background: #fff;
        float: left;
        border: 1px solid #d8d8d8;
        position: relative;
        border-radius: 6px;
        padding: 8px 12px;
        max-width: 82%;
        width: auto;
        word-break: break-all;
        word-wrap: break-word;
    }
    .block .content:before{
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
        top: 16px;
        border-width: 6px;
        margin-top: -6px;
        border-right-color: #d8d8d8;
        left:-13px;
    }
    .block .content:after{
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
        top: 16px;
        border-width: 6px;
        margin-top: -6px;
        border-right-color: #fff;
        left:-11px;
    }
    .block .avatar{
        width:36px;margin-left: 20px
    }
    .block .avatar img{
        max-width: 100%;
    }
    .user{
        height:36px;
        line-height: 36px;
        font-size: 16px;
        font-family: serif;
        cursor: pointer;
    }
    .user:hover{
        background-color: #f0f0f0
    }
    .user.active{
        background-color: #45818e;
        color: #fff
    }
    
    .user .avatar img{
        max-width: 200%;width:36px;position: relative;right: 0
    }

    </style>
    <div class="container">
        <div class="row box">
            <div class="col-12 top">
                <h3>涵予科技在线客服</h3>
            </div>
            <div class="col-sm-2 col-12 ad">
                <div class="user row t">
                    <div class="avatar col-3">
                        <img src="http://new.shuhuaty.com/templets/default/images/tx_shuhua.png" alt="">
                    </div>
                    <div class="name col-9">
                        name
                    </div>
                </div>
                <div class="user row t active">
                    <div class="avatar col-3">
                        <img src="http://new.shuhuaty.com/templets/default/images/tx_shuhua.png" alt="">
                    </div>
                    <div class="name col-9">
                        name
                    </div>
                </div>
                <div class="user row t">
                    <div class="avatar col-3">
                        <img src="http://new.shuhuaty.com/templets/default/images/tx_shuhua.png" alt="">
                    </div>
                    <div class="name col-9">
                        name
                    </div>
                </div>
            </div>
            <div class="col-sm-10 col-12 main">
                <div class="message-box">
                    
                    

                </div>
                <div class="message-bar"></div>
                <div class="message-send">
                    <textarea name="" id="" cols="30" rows="10"></textarea>
                    <button class="button send t">发送</button>
                </div>

            </div>
        </div>

    </div>


    <script>

        Number.prototype.m2 = function(){
            return this<10?'0'+this:this;
        }

        var addMessageContent = function(avatar,name,message){
            var html = '<div class="block"><div class="avatar"><img></div><div class="content"><p class="text-muted"><small></small></p><p class="message"></p></div></div>';
            var html = $(html);
            var date = new Date;
            html.find('.avatar img')[0].src = avatar;
            html.find('small').text(name+' '+date.getHours().m2()+':'+date.getMinutes().m2()+':'+date.getSeconds().m2());
            html.find('.message').html(message.replace(/[\n]/g,"<br>"));
            $('.message-box').append(html)
        }

        var user,pwd,uid,nickname;

        if(pwd = prompt()){
            user = 'admin';
            nickname = '涵予科技';
        }

        var host   = 'ws://127.0.0.1:7777';
        var socket = null;
        var output = document.getElementById('output');
        var print  = function (message) {
            var samp       = document.createElement('p');
            $(samp).text(message);
            $(output).append(samp);

            return;
        };


        $('textarea').keyup(function(evt){
            if (13 === evt.keyCode) {

            }
        })
        $('.send').click(function (evt) {
            // if (13 === evt.keyCode) {
            if(1){
                var msg = $('textarea').val()

                if (!msg) {
                    return;
                }
                
                try {
                    var e = JSON.stringify({type:'user_message',uid:'admin',message:msg})
                    socket.send(e);
                    $('textarea').val('')
                    $('textarea').focus();
                } catch (e) {
                    console.log(e);
                }

                return;
            }
        });
        try {
            socket = new WebSocket(host);
            socket.onopen = function () {
                print('connection is opened');
                $('textarea').focus();

                var e = JSON.stringify({type:'user_login',uid:user,password:pwd,nickname:nickname})
                socket.send(e);

                return;
            };
            socket.onmessage = function (msg) {
                try{
                    var obj = JSON.parse(msg.data);
                    switch(obj.type){
                        case 'connect':
                            print('connection success');
                            break;
                        case 'user_login':
                            uid = obj.uid
                            print('login success');
                            break;
                        case 'user_message':
                            addMessageContent('http://new.shuhuaty.com/templets/default/images/tx_shuhua.png',obj.nickname,obj.message);
                            break;
                        case 'err':
                            alert(obj.message);
                            break;
                        default:
                            print(msg.data);
                            break;
                    }

                }catch(e){
                    print('error!');
                }
                

                return;
            };
            socket.onclose = function () {
                print('connection is closed');

                return;
            };
        } catch (e) {
            console.log(e);
        }

    </script>


</body>
</html>